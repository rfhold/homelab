services:
  vllm:
    build:
      context: .
      dockerfile: Dockerfile
    image: vllm-rocm:latest
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    security_opt:
      - seccomp=unconfined
    cap_add:
      - SYS_PTRACE
    ulimits:
      memlock:
        soft: -1
        hard: -1
      stack:
        soft: 67108864
        hard: 67108864
    group_add:
      - video
      - render
    ipc: host
    environment:
      - HSA_OVERRIDE_GFX_VERSION=11.5.1
      - HF_HOME=/workspace/models
      - VLLM_TORCH_COMPILE_LEVEL=0
      - HIP_VISIBLE_DEVICES=0
      - GPU_DEVICE_ORDINAL=0
    volumes:
      - ${HF_HOME:-~/.cache/huggingface}:/workspace/models
    ports:
      - "8000:8000"
    command:
      - serve
      - --host
      - 0.0.0.0
      - --port
      - "8000"
      - --dtype
      - float16
