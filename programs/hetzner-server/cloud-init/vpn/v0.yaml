#cloud-config
package_update: true
package_upgrade: true

users:
  - default
  - name: admin
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: true

packages:
  - curl
  - wget
  - vim
  - htop
  - git
  - unzip
  - fail2ban
  - ufw
  - wireguard
  - wireguard-tools
  - iptables

write_files:
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      ChallengeResponseAuthentication no
      UsePAM yes
      X11Forwarding no
      MaxAuthTries 3
      ClientAliveInterval 300
      ClientAliveCountMax 2

  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 1h
      findtime = 10m
      maxretry = 5
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3

  - path: /etc/sysctl.d/99-vpn-hardening.conf
    content: |
      net.ipv4.ip_forward = 1
      net.ipv6.conf.all.forwarding = 1
      net.ipv4.conf.all.rp_filter = 1
      net.ipv4.conf.default.rp_filter = 1
      net.ipv4.tcp_syncookies = 1
      net.ipv4.tcp_max_syn_backlog = 4096
      net.ipv4.tcp_synack_retries = 2
      net.ipv4.tcp_rfc1337 = 1
      net.ipv4.tcp_timestamps = 0
      net.ipv4.tcp_sack = 1
      net.ipv4.icmp_echo_ignore_broadcasts = 1
      net.ipv4.icmp_ignore_bogus_error_responses = 1
      net.ipv4.icmp_ratelimit = 100
      net.ipv4.conf.all.accept_source_route = 0
      net.ipv4.conf.default.accept_source_route = 0
      net.ipv6.conf.all.accept_source_route = 0
      net.ipv6.conf.default.accept_source_route = 0
      net.ipv4.conf.all.accept_redirects = 0
      net.ipv4.conf.default.accept_redirects = 0
      net.ipv6.conf.all.accept_redirects = 0
      net.ipv6.conf.default.accept_redirects = 0
      net.ipv4.conf.all.send_redirects = 0
      net.ipv4.conf.default.send_redirects = 0
      net.ipv4.conf.all.secure_redirects = 0
      net.ipv4.conf.default.secure_redirects = 0
      net.ipv4.conf.all.log_martians = 1
      net.ipv4.conf.default.log_martians = 1
      net.ipv6.conf.all.accept_ra = 0
      net.ipv6.conf.default.accept_ra = 0
      kernel.kptr_restrict = 2
      kernel.dmesg_restrict = 1
      kernel.core_pattern = |/bin/false
      fs.suid_dumpable = 0
      net.core.default_qdisc = fq
      net.ipv4.tcp_congestion_control = bbr
      vm.swappiness = 10
      vm.mmap_min_addr = 65536
      net.core.rmem_max = 16777216
      net.core.wmem_max = 16777216
      net.ipv4.tcp_rmem = 4096 87380 16777216
      net.ipv4.tcp_wmem = 4096 65536 16777216

  - path: /etc/wireguard/helper/add-nat-routing.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      WG_IF="wg0"
      SERVER_PUB_IF=$(ip route | grep default | awk '{print $5}' | head -1)
      SUB_NET="10.8.0.0/24"
      SUB_NET_6="fd42:42:42::/112"
      
      iptables -t nat -I POSTROUTING 1 -s $SUB_NET -o $SERVER_PUB_IF -j MASQUERADE
      iptables -I INPUT 1 -i $WG_IF -j ACCEPT
      iptables -I FORWARD 1 -i $SERVER_PUB_IF -o $WG_IF -j ACCEPT
      iptables -I FORWARD 1 -i $WG_IF -o $SERVER_PUB_IF -j ACCEPT
      
      ip6tables -t nat -I POSTROUTING 1 -s $SUB_NET_6 -o $SERVER_PUB_IF -j MASQUERADE
      ip6tables -I INPUT 1 -i $WG_IF -j ACCEPT
      ip6tables -I FORWARD 1 -i $SERVER_PUB_IF -o $WG_IF -j ACCEPT
      ip6tables -I FORWARD 1 -i $WG_IF -o $SERVER_PUB_IF -j ACCEPT

  - path: /etc/wireguard/helper/remove-nat-routing.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      WG_IF="wg0"
      SERVER_PUB_IF=$(ip route | grep default | awk '{print $5}' | head -1)
      SUB_NET="10.8.0.0/24"
      SUB_NET_6="fd42:42:42::/112"
      
      iptables -t nat -D POSTROUTING -s $SUB_NET -o $SERVER_PUB_IF -j MASQUERADE
      iptables -D INPUT -i $WG_IF -j ACCEPT
      iptables -D FORWARD -i $SERVER_PUB_IF -o $WG_IF -j ACCEPT
      iptables -D FORWARD -i $WG_IF -o $SERVER_PUB_IF -j ACCEPT
      
      ip6tables -t nat -D POSTROUTING -s $SUB_NET_6 -o $SERVER_PUB_IF -j MASQUERADE
      ip6tables -D INPUT -i $WG_IF -j ACCEPT
      ip6tables -D FORWARD -i $SERVER_PUB_IF -o $WG_IF -j ACCEPT
      ip6tables -D FORWARD -i $WG_IF -o $SERVER_PUB_IF -j ACCEPT

  - path: /etc/wireguard/wg0.conf.template
    permissions: '0600'
    content: |
      [Interface]
      PrivateKey = SERVER_PRIVATE_KEY
      Address = 10.8.0.1/24, fd42:42:42::1/112
      ListenPort = 51820
      MTU = 1280
      
      PostUp = /etc/wireguard/helper/add-nat-routing.sh
      PostDown = /etc/wireguard/helper/remove-nat-routing.sh

  - path: /etc/systemd/system/wstunnel.service
    content: |
      [Unit]
      Description=wstunnel for WireGuard obfuscation
      After=network-online.target wg-quick@wg0.service
      Wants=network-online.target
      Requires=wg-quick@wg0.service
      
      [Service]
      Type=exec
      EnvironmentFile=/etc/wstunnel/secret.env
      ExecStart=/usr/local/bin/wstunnel server --restrict-http-upgrade-path-prefix ${WSTUNNEL_SECRET} --restrict-to 127.0.0.1:51820 wss://0.0.0.0:443
      Restart=on-failure
      RestartSec=5
      
      CapabilityBoundingSet=CAP_NET_BIND_SERVICE
      AmbientCapabilities=CAP_NET_BIND_SERVICE
      
      [Install]
      WantedBy=multi-user.target

  - path: /etc/systemd/system/wg-quick@wg0.service.d/hardening.conf
    content: |
      [Service]
      RuntimeDirectory=wireguard
      ReadWritePaths=/run/wireguard /etc/wireguard

  - path: /usr/local/bin/setup-wireguard.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e
      
      if [ ! -f /etc/wireguard/server_private ]; then
        wg genkey | tee /etc/wireguard/server_private | wg pubkey > /etc/wireguard/server_public
        wg genpsk > /etc/wireguard/preshared
        chmod 600 /etc/wireguard/server_private /etc/wireguard/preshared
        
        PRIVATE_KEY=$(cat /etc/wireguard/server_private)
        sed "s|SERVER_PRIVATE_KEY|$PRIVATE_KEY|g" /etc/wireguard/wg0.conf.template > /etc/wireguard/wg0.conf
        chmod 600 /etc/wireguard/wg0.conf
      fi
      
      if [ ! -f /etc/wstunnel/secret.env ]; then
        mkdir -p /etc/wstunnel
        echo "WSTUNNEL_SECRET=$(head -c 32 /dev/urandom | base64 | tr -d '/+=' | head -c 32)" > /etc/wstunnel/secret.env
        chmod 600 /etc/wstunnel/secret.env
      fi

runcmd:
  - mkdir -p /home/admin/.ssh
  - cp /root/.ssh/authorized_keys /home/admin/.ssh/authorized_keys
  - chown -R admin:admin /home/admin/.ssh
  - chmod 700 /home/admin/.ssh
  - chmod 600 /home/admin/.ssh/authorized_keys
  - systemctl restart sshd
  - systemctl enable fail2ban
  - systemctl start fail2ban
  - sysctl --system
  - mkdir -p /etc/wireguard/helper
  - mkdir -p /etc/systemd/system/wg-quick@wg0.service.d
  - mkdir -p /run/wireguard
  - |
    WSTUNNEL_VERSION=$(curl -s https://api.github.com/repos/erebe/wstunnel/releases/latest | grep tag_name | cut -d '"' -f 4)
    WSTUNNEL_VERSION_NO_V=$(echo "$WSTUNNEL_VERSION" | sed 's/^v//')
    curl -fLo /tmp/wstunnel.tar.gz "https://github.com/erebe/wstunnel/releases/download/$WSTUNNEL_VERSION/wstunnel_${WSTUNNEL_VERSION_NO_V}_linux_amd64.tar.gz"
    curl -fLo /tmp/checksums.txt "https://github.com/erebe/wstunnel/releases/download/$WSTUNNEL_VERSION/checksums.txt"
    cd /tmp && sha256sum -c checksums.txt --ignore-missing
    tar -xzf /tmp/wstunnel.tar.gz -C /usr/local/bin wstunnel
    chmod +x /usr/local/bin/wstunnel
    setcap cap_net_bind_service=+ep /usr/local/bin/wstunnel
    rm /tmp/wstunnel.tar.gz /tmp/checksums.txt
  - /usr/local/bin/setup-wireguard.sh
  - systemctl daemon-reload
  - systemctl enable wg-quick@wg0
  - systemctl start wg-quick@wg0
  - systemctl enable wstunnel
  - systemctl start wstunnel
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw deny 51820/udp comment 'block direct wireguard'
  - ufw allow 443/tcp comment 'wstunnel'
  - ufw route allow in on wg0 out on eth0
  - ufw --force enable
